FROM node:8.8.1 as static

RUN yarn global add npm@5.5.1
RUN npm install -g lerna@2.5.1
WORKDIR /srv/app
RUN chown node.node /srv/app
COPY --chown=node:node shared shared
COPY --chown=node:node client client
COPY --chown=node:node server/locale server/locale
WORKDIR shared
USER node
RUN npm run lerna -- bootstrap

FROM python:3.6-stretch

RUN adduser --uid 1000 --gecos --quiet --disabled-password sk

ENV DJANGO_SETTINGS_MODULE=sk.settings.docker_local \
    DEBUG=false \
    SERVE_MEDIA=false \
    EDITOR=vim

RUN apt-get update && apt-get -y install \
    build-essential \
    vim \
    git \
    python-dev \
    default-libmysqlclient-dev \
    libffi-dev \
    libxml2-dev \
    libxslt1-dev \
    # PDF generation
    libfontconfig1 \
    libfontconfig1-dev \
    wkhtmltopdf \
    xvfb \
    # Image manipulation / Pillow
    zlib1g-dev \
    libpq-dev \
    libcairo2-dev \
    libpango1.0-0 \
    libgdk-pixbuf2.0-0 \
    shared-mime-info \
    libjpeg-dev \
    # geodjango
    binutils \
    libproj-dev \
    gdal-bin \
    python-gdal \
    # install django_auth_ldap requirements
    libldap2-dev \
    libsasl2-dev  \
    gettext \
    telnet \
    # cleanup
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && pip install --upgrade pip

COPY *requirements.in ./
COPY *requirements.txt ./

# TODO: remove downgrade of setuptools after fudge is fixed https://github.com/fudge-py/fudge/issues/13
RUN pip install pip-tools 'setuptools<58' --force-reinstall

ARG PIP_TOOLS_DEV_REQUIREMENTS_IN_FILES
ARG PIP_TOOLS_DEV_REQUIREMENTS_OUTFILE

ENV CUSTOM_COMPILE_COMMAND="DO NOT EDIT THIS FILE! Instead, edit the \*requirements.in file(s), then run script-docker/update_requirements"


RUN touch $PIP_TOOLS_DEV_REQUIREMENTS_IN_FILES
RUN pip-compile requirements.in
RUN pip-compile $PIP_TOOLS_DEV_REQUIREMENTS_IN_FILES --output-file ./$PIP_TOOLS_DEV_REQUIREMENTS_OUTFILE
RUN pip-sync requirements.txt $PIP_TOOLS_DEV_REQUIREMENTS_OUTFILE \
    && rm -r ~/.cache/

RUN mkdir /srv/app
WORKDIR /srv/app
COPY server server
COPY --chown=sk:sk --from=static /srv/app/static static

WORKDIR /srv/app/server
USER sk

LABEL app="sk"

# vim:set ft=dockerfile:
